<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ABG + NIV Helper</title>
  <style>
    :root {
      --bg: #0b0f1a;
      --panel: #12192b;
      --card: #162136;
      --border: rgba(255, 255, 255, 0.06);
      --muted: rgba(255, 255, 255, 0.7);
      --text: #f3f6ff;
      --accent: #7ac7ff;
      --good: #3dd598;
      --warn: #ffb547;
      --bad: #ff6b6b;
      --chip: rgba(255,255,255,0.08);
      --shadow: 0 12px 30px rgba(0,0,0,0.35);
      font-family: "Inter", "SF Pro Display", "Segoe UI", system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 10% 5%, rgba(16,155,255,0.22), transparent 55%),
                  radial-gradient(1000px 600px at 90% 10%, rgba(160,120,255,0.14), transparent 55%),
                  radial-gradient(900px 600px at 20% 90%, rgba(16,255,182,0.12), transparent 55%),
                  linear-gradient(165deg, #0b0f1a, #0e1526 50%, #0b0f1a);
      color: var(--text);
      padding: 18px;
      line-height: 1.45;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(11,15,26,0.9), rgba(11,15,26,0.3));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 14px 12px;
      margin: -18px -18px 18px;
    }
    h1 { margin: 0; font-weight: 700; letter-spacing: -0.01em; }
    p.lead { margin: 6px 0 0; color: var(--muted); }
    .wrap { max-width: 1200px; margin: 0 auto; display: grid; gap: 16px; }
    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .tab {
      padding: 12px;
      text-align: center;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
      user-select: none;
    }
    .tab.active { border-color: rgba(122,199,255,0.6); background: #1b2942; transform: translateY(-1px); }
    .tab small { display: block; color: var(--muted); margin-top: 4px; }
    .panel {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    h2 { margin-top: 0; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-3 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    label { display: block; color: var(--muted); font-size: 0.92rem; margin-bottom: 4px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    textarea { min-height: 68px; resize: vertical; }
    input:focus, select:focus, textarea:focus {
      border-color: rgba(122,199,255,0.8);
      box-shadow: 0 0 0 3px rgba(122,199,255,0.1);
    }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(120deg, #2a9df4, #6ed6ff);
      color: #04101d;
      box-shadow: 0 12px 25px rgba(46,153,255,0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: none;
    }
    button:hover { transform: translateY(-1px); }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border);
    }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.9rem;
      background: var(--chip);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .chip.good { border-color: rgba(61,213,152,0.5); color: var(--good); }
    .chip.warn { border-color: rgba(255,181,71,0.5); color: var(--warn); }
    .chip.bad  { border-color: rgba(255,107,107,0.5); color: var(--bad); }
    .muted { color: var(--muted); }
    .result { white-space: pre-wrap; margin: 0; font-family: "SFMono-Regular", ui-monospace, monospace; }
    details summary { cursor: pointer; color: var(--muted); }
    .hidden { display: none; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .flex { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .disclaimer {
      margin-top: 18px;
      color: var(--muted);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ABG + Oxygen Device → NIV, CPAP & HFNC Helper</h1>
  </header>

  <main class="wrap">
    <div class="tabs">
      <div class="tab active" id="tabA" onclick="showTab('A')">Section A <small>Baseline</small></div>
      <div class="tab" id="tabB" onclick="showTab('B')">Section B <small>Repeat / response</small></div>
      <div class="tab" id="tabSum" onclick="showTab('Sum')">Summary <small>Handover-ready</small></div>
    </div>

    <div class="panel" id="sectionA">
      <div class="flex" style="justify-content: space-between; align-items: baseline;">
        <div>
          <h2>Section A · Baseline ABG & oxygen device</h2>
          <p class="muted">Enter the initial ABG on a known device (or room air). The helper estimates FiO₂, interprets oxygenation + acid–base and suggests specific starting settings.</p>
        </div>
        <div class="actions">
          <button class="secondary" onclick="fillExampleA()">Example A</button>
          <button class="secondary" onclick="clearA()">Clear A</button>
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="contextA">Clinical context</label>
          <select id="contextA">
            <option value="unknown">Unknown / Mixed</option>
            <option value="copd">COPD / CO₂ retainer</option>
            <option value="cardio">Cardiogenic pulmonary edema</option>
            <option value="hypox">Severe hypoxemia (pneumonia/ARDS)</option>
            <option value="asthma">Asthma</option>
            <option value="metabolic">Lactic / metabolic acidosis</option>
          </select>
        </div>
        <div>
          <label for="targetSpO2">SpO₂ target</label>
          <select id="targetSpO2" onchange="handleTargetChange()">
            <option value="88-92">88–92% (COPD/retention)</option>
            <option value="92-96" selected>92–96% (most adults)</option>
            <option value="94-98">94–98% (neuro/trauma)</option>
            <option value="custom">Custom</option>
          </select>
          <input id="spo2Custom" class="hidden" placeholder="e.g., 90–94%">
        </div>
        <div>
          <label for="units">ABG units</label>
          <select id="units">
            <option value="mmhg" selected>mmHg</option>
            <option value="kpa">kPa</option>
          </select>
        </div>
        <div>
          <label for="heightA">Height (cm) (optional)</label>
          <input id="heightA" type="number" step="0.5" placeholder="e.g., 170">
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="deviceA">Device at ABG</label>
          <select id="deviceA" onchange="handleDeviceChangeA()">
            <option value="ra">Room air</option>
            <option value="nc">Nasal cannula</option>
            <option value="simple">Simple mask</option>
            <option value="nrb">Non-rebreather</option>
            <option value="venturi">Venturi (set FiO₂)</option>
            <option value="hfnc">HFNC (set FiO₂ + flow)</option>
            <option value="niv">NIV/CPAP (set FiO₂)</option>
          </select>
        </div>
        <div>
          <label for="flowFiO2A">Flow (L/min) or FiO₂ (%)</label>
          <input id="flowFiO2A" type="number" step="0.1" placeholder="e.g., 4 (NC) or 40 (FiO₂%)">
        </div>
        <div id="hfncFlowA_wrap" class="hidden">
          <label for="hfncFlowA">HFNC flow (L/min)</label>
          <input id="hfncFlowA" type="number" step="1" placeholder="e.g., 50">
        </div>
        <div>
          <label for="noteA">Device notes (optional)</label>
          <input id="noteA" placeholder="e.g., poor mask seal">
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="pH_A">pH</label>
          <input id="pH_A" type="number" step="0.01">
        </div>
        <div>
          <label for="PaCO2_A">PaCO₂</label>
          <input id="PaCO2_A" type="number" step="0.1">
        </div>
        <div>
          <label for="PaO2_A">PaO₂</label>
          <input id="PaO2_A" type="number" step="0.1">
        </div>
        <div>
          <label for="HCO3_A">HCO₃⁻</label>
          <input id="HCO3_A" type="number" step="0.1">
        </div>
        <div>
          <label for="RR_A">Respiratory rate</label>
          <input id="RR_A" type="number" step="1">
        </div>
        <div>
          <label for="SpO2_A">SpO₂ (optional)</label>
          <input id="SpO2_A" type="number" step="1">
        </div>
      </div>

      <details>
        <summary>Optional labs (anion gap, lactate, HACOR)</summary>
        <div class="grid cols-3">
          <div>
            <label for="Na_A">Na⁺</label>
            <input id="Na_A" type="number">
          </div>
          <div>
            <label for="Cl_A">Cl⁻</label>
            <input id="Cl_A" type="number">
          </div>
          <div>
            <label for="Alb_A">Albumin (g/dL)</label>
            <input id="Alb_A" type="number" step="0.1">
          </div>
          <div>
            <label for="Lac_A">Lactate</label>
            <input id="Lac_A" type="number" step="0.1">
          </div>
          <div>
            <label for="HR_A">HR (HACOR)</label>
            <input id="HR_A" type="number">
          </div>
          <div>
            <label for="GCS_A">GCS (HACOR)</label>
            <input id="GCS_A" type="number">
          </div>
        </div>
        <p class="muted">HACOR uses HR, pH, GCS, RR, and PaO₂/FiO₂. FiO₂ is estimated when derived from flow.</p>
      </details>

      <div class="actions" style="margin-top: 10px;">
        <button onclick="analyseA()">Analyse A</button>
      </div>

      <div class="grid cols-2" style="margin-top: 12px;">
        <div class="card">
          <div class="pill">Results (A)</div>
          <pre id="resultA" class="result muted">Enter Section A and click “Analyse A”.</pre>
          <div id="indicesA" class="chips"></div>
          <div id="flagsA" class="chips"></div>
        </div>
        <div class="card">
          <div class="pill">Respiratory support recommendation</div>
          <pre id="supportA" class="result muted">Will populate with: WHAT + WHY + CONFIDENCE.</pre>
          <div id="supportChipsA" class="chips"></div>
        </div>
      </div>
    </div>

    <div class="panel hidden" id="sectionB">
      <div class="flex" style="justify-content: space-between; align-items: baseline;">
        <div>
          <h2>Section B · Repeat ABG & response</h2>
          <p class="muted">Enter the repeat ABG and time on therapy. The helper compares trends, flags failing trial logic, and suggests *specific* adjustments.</p>
        </div>
        <div class="actions">
          <button class="secondary" onclick="fillExampleB()">Example B</button>
          <button class="secondary" onclick="clearB()">Clear B</button>
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="minsB">Minutes on therapy</label>
          <input id="minsB" type="number" placeholder="e.g., 60">
        </div>
        <div>
          <label for="therapyB">Therapy device during repeat</label>
          <select id="therapyB" onchange="handleTherapyChangeB()">
            <option value="niv">BiPAP/NIV</option>
            <option value="cpap">CPAP</option>
            <option value="hfnc">HFNC</option>
            <option value="cannula">Simple nasal cannula</option>
            <option value="venturi">Venturi</option>
            <option value="nrb">Non-rebreather</option>
          </select>
        </div>
        <div>
          <label for="settingsB">Settings (optional)</label>
          <input id="settingsB" placeholder="e.g., IPAP 14 / EPAP 5 or CPAP 10">
        </div>
        <div id="hfncFlowB_wrap" class="hidden">
          <label for="hfncFlowB">HFNC flow (L/min)</label>
          <input id="hfncFlowB" type="number" step="1" placeholder="e.g., 55">
        </div>
      </div>

      <div class="grid cols-3">
        <div>
          <label for="FiO2_B">FiO₂ (%) (preferred)</label>
          <input id="FiO2_B" type="number" placeholder="e.g., 35">
        </div>
        <div>
          <label for="pH_B">pH</label>
          <input id="pH_B" type="number" step="0.01">
        </div>
        <div>
          <label for="PaCO2_B">PaCO₂</label>
          <input id="PaCO2_B" type="number" step="0.1">
        </div>
        <div>
          <label for="PaO2_B">PaO₂</label>
          <input id="PaO2_B" type="number" step="0.1">
        </div>
        <div>
          <label for="HCO3_B">HCO₃⁻</label>
          <input id="HCO3_B" type="number" step="0.1">
        </div>
        <div>
          <label for="RR_B">Respiratory rate</label>
          <input id="RR_B" type="number">
        </div>
        <div>
          <label for="SpO2_B">SpO₂ (optional)</label>
          <input id="SpO2_B" type="number">
        </div>
      </div>

      <details>
        <summary>Optional: lactate & HACOR (B)</summary>
        <div class="grid cols-3">
          <div>
            <label for="Lac_B">Lactate</label>
            <input id="Lac_B" type="number" step="0.1">
          </div>
          <div>
            <label for="HR_B">HR</label>
            <input id="HR_B" type="number">
          </div>
          <div>
            <label for="GCS_B">GCS</label>
            <input id="GCS_B" type="number">
          </div>
        </div>
      </details>

      <div class="actions" style="margin-top: 10px;">
        <button onclick="analyseB()">Analyse B</button>
      </div>

      <div class="grid cols-2" style="margin-top: 12px;">
        <div class="card">
          <div class="pill">Response & treatment suggestions (B)</div>
          <pre id="resultB" class="result muted">Complete Section A first. Enter repeat ABG and click “Analyse B”.</pre>
          <div id="flagsB" class="chips"></div>
        </div>
        <div class="card">
          <div class="pill">V/Q vs shunt-like heuristics</div>
          <pre id="vqB" class="result muted">Will summarise patterns once both ABGs are analysed.</pre>
          <div id="chipsB" class="chips"></div>
        </div>
      </div>
    </div>

    <div class="panel hidden" id="sectionSum">
      <div class="flex" style="justify-content: space-between; align-items: baseline;">
        <div>
          <h2>Summary</h2>
          <p class="muted">Narrative handover: baseline interpretation, initial plan, repeat response, and next steps.</p>
        </div>
        <div class="actions">
          <button class="secondary" onclick="copySummary()">Copy summary</button>
        </div>
      </div>
      <div class="card">
        <div class="pill">Handover narrative</div>
        <pre id="summary" class="result muted">Perform Sections A and B to generate a summary.</pre>
      </div>
    </div>

    <div class="disclaimer">
      <strong>Important:</strong> This is an educational decision-support aid, not a protocol. Always apply local guidance, contraindications, and senior/ICU input where appropriate.
    </div>
  </main>

  <script>
    let baselineData = null;
    let repeatData = null;

    function showTab(tab) {
      document.getElementById('sectionA').classList.toggle('hidden', tab !== 'A');
      document.getElementById('sectionB').classList.toggle('hidden', tab !== 'B');
      document.getElementById('sectionSum').classList.toggle('hidden', tab !== 'Sum');
      ['A', 'B', 'Sum'].forEach(t => document.getElementById('tab' + t).classList.toggle('active', t === tab));
    }

    function handleTargetChange() {
      const custom = document.getElementById('spo2Custom');
      custom.classList.toggle('hidden', document.getElementById('targetSpO2').value !== 'custom');
    }

    function handleDeviceChangeA() {
      const dev = document.getElementById('deviceA').value;
      document.getElementById('hfncFlowA_wrap').classList.toggle('hidden', dev !== 'hfnc');
    }

    function handleTherapyChangeB() {
      const t = document.getElementById('therapyB').value;
      document.getElementById('hfncFlowB_wrap').classList.toggle('hidden', t !== 'hfnc');
    }

    function num(id) {
      const v = document.getElementById(id).value;
      if (v === '') return NaN;
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function toMmHg(v, units) {
      if (!Number.isFinite(v)) return NaN;
      return units === 'kpa' ? v * 7.50062 : v;
    }

    function getTargetSpO2Text() {
      const sel = document.getElementById('targetSpO2').value;
      if (sel === 'custom') return (document.getElementById('spo2Custom').value || 'custom');
      return sel;
    }

    // FiO2 estimation
    function estimateFiO2(device, flowFi) {
      if (device === 'ra') return { min: 0.21, max: 0.21, info: 'Room air' };
      if (!Number.isFinite(flowFi)) return { min: NaN, max: NaN, info: 'Flow/FiO₂ missing' };
      if (flowFi <= 0) return { min: NaN, max: NaN, info: 'Flow/FiO₂ must be > 0' };

      // If user entered FiO2 as % (>=22) treat as set
      if (flowFi >= 22) {
        const f = Math.min(1, Math.max(0.21, flowFi / 100));
        return { min: f, max: f, info: 'Set FiO₂' };
      }

      const L = flowFi;
      if (device === 'nc') {
        return { min: Math.min(1, 0.21 + 0.03 * L), max: Math.min(1, 0.21 + 0.04 * L), info: 'Nasal cannula approximation' };
      }
      if (device === 'simple') {
        return { min: Math.min(1, 0.28 + 0.02 * (L - 6)), max: Math.min(1, 0.44 + 0.02 * (L - 6)), info: 'Simple mask approximation' };
      }
      if (device === 'nrb') {
        return { min: Math.min(1, 0.60 + 0.01 * (L - 10)), max: Math.min(1, 0.80 + 0.02 * (L - 10)), info: 'NRB approximation' };
      }

      // Venturi/HFNC/NIV: must input FiO2 %
      return { min: NaN, max: NaN, info: 'For Venturi/HFNC/NIV please enter set FiO₂ (%)' };
    }

    function calcOxygenation(PaO2, PaCO2, FiMin, FiMax) {
      const pfLow = Number.isFinite(PaO2) && Number.isFinite(FiMax) ? PaO2 / FiMax : NaN;
      const pfHigh = Number.isFinite(PaO2) && Number.isFinite(FiMin) ? PaO2 / FiMin : NaN;
      let AAGmin = NaN, AAGmax = NaN, aAmin = NaN, aAmax = NaN;
      if ([PaO2, PaCO2, FiMin, FiMax].every(Number.isFinite)) {
        const PA = (Fi) => Fi * (760 - 47) - PaCO2 / 0.8;
        const PAmin = PA(FiMin);
        const PAmax = PA(FiMax);
        AAGmin = Math.min(PAmin - PaO2, PAmax - PaO2);
        AAGmax = Math.max(PAmin - PaO2, PAmax - PaO2);
        aAmin = Math.min(PaO2 / PAmin, PaO2 / PAmax);
        aAmax = Math.max(PaO2 / PAmin, PaO2 / PAmax);
      }
      return { pfLow, pfHigh, AAGmin, AAGmax, aAmin, aAmax };
    }

    function calcAnionGap(na, cl, hco3, alb) {
      if (![na, cl, hco3].every(Number.isFinite)) return null;
      const ag = na - cl - hco3;
      if (!Number.isFinite(alb)) return { ag, agCorr: ag };
      const agCorr = ag + 2.5 * (4 - alb);
      return { ag, agCorr };
    }

    function analyseAcidBase(pH, pCO2, hco3) {
      if (![pH, pCO2, hco3].every(Number.isFinite)) return { text: 'Need pH, PaCO₂, HCO₃⁻ to interpret.', flags: [] };
      const lines = [];
      const flags = [];
      const acidemia = pH < 7.35;
      const alkalemia = pH > 7.45;

      const metaAcid = hco3 < 22;
      const metaAlk = hco3 > 26;
      const respAcid = pCO2 > 45;
      const respAlk = pCO2 < 35;

      if (acidemia && respAcid && !metaAcid) lines.push('Primary respiratory acidosis');
      else if (acidemia && metaAcid && !respAcid) lines.push('Primary metabolic acidosis');
      else if (alkalemia && respAlk && !metaAlk) lines.push('Primary respiratory alkalosis');
      else if (alkalemia && metaAlk && !respAlk) lines.push('Primary metabolic alkalosis');
      else if (metaAcid && respAcid) lines.push('Mixed metabolic + respiratory acidosis');
      else if (metaAlk && respAlk) lines.push('Mixed metabolic + respiratory alkalosis');
      else lines.push('Near-normal pH / compensated / mixed pattern');

      if (metaAcid) {
        const expCO2 = 1.5 * hco3 + 8;
        lines.push(`Winter's: expected PaCO₂ ≈ ${expCO2.toFixed(1)} ±2 mmHg`);
        if (pCO2 > expCO2 + 2) lines.push('→ PaCO₂ higher than expected: ventilatory failure on top of metabolic acidosis?');
        if (pCO2 < expCO2 - 2) lines.push('→ PaCO₂ lower than expected: concurrent respiratory alkalosis?');
      }

      if (pH < 7.25) flags.push('pH < 7.25 (high risk)');
      if (pCO2 > 80) flags.push('PaCO₂ > 80 (very high risk)');
      if (pCO2 > 60) flags.push('PaCO₂ > 60 (hypercapnia)');
      return { text: lines.join('\n'), flags };
    }

    function calcHACOR(hr, pH, gcs, rr, pao2, fio2Min, fio2Max) {
      // Simplified scoring for display; threshold logic used mainly (>5)
      if (![hr, pH, gcs, rr, pao2, fio2Min, fio2Max].every(Number.isFinite)) return null;

      const hrPts = hr >= 121 ? 1 : 0;

      let pHPts = 0;
      if (pH < 7.25) pHPts = 4;
      else if (pH < 7.30) pHPts = 3;
      else if (pH < 7.35) pHPts = 2;

      let gcsPts = 0;
      if (gcs < 11) gcsPts = 10;
      else if (gcs < 13) gcsPts = 5;
      else if (gcs < 15) gcsPts = 2;

      let rrPts = 0;
      if (rr > 45) rrPts = 4;
      else if (rr > 40) rrPts = 3;
      else if (rr > 35) rrPts = 2;
      else if (rr > 30) rrPts = 1;

      const pfLow = pao2 / fio2Max;
      const pfHigh = pao2 / fio2Min;
      const pfAvg = (pfLow + pfHigh) / 2;
      let pfPts = 0;
      if (pfAvg < 100) pfPts = 6;
      else if (pfAvg < 126) pfPts = 5;
      else if (pfAvg < 151) pfPts = 4;
      else if (pfAvg < 176) pfPts = 3;
      else if (pfAvg < 201) pfPts = 2;

      const total = hrPts + pHPts + gcsPts + rrPts + pfPts;
      return { total };
    }

    function chipClassForText(t) {
      if (/STRONG/i.test(t)) return 'chip good';
      if (/MODERATE/i.test(t)) return 'chip warn';
      return 'chip bad';
    }

    function renderChips(containerId, items) {
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      items.forEach(item => {
        const span = document.createElement('span');
        span.className = 'chip';
        if (/high risk|HACOR|pH < 7\.2|PaCO₂ > 80|Low P\/F|fails/i.test(item)) span.classList.add('bad');
        else if (/PaCO₂ > 60|A–a|risk|No pH improvement|not improving|V\/Q/i.test(item)) span.classList.add('warn');
        else span.classList.add('good');
        span.textContent = item;
        el.appendChild(span);
      });
    }

    function renderSupportPlan(containerId, chipsId, plan) {
      // plan: array of {title, settings, why, confidence, next}
      const out = [];
      const chips = [];
      plan.forEach((p, i) => {
        out.push(`${i+1}) ${p.title}`);
        out.push(`   Settings: ${p.settings}`);
        out.push(`   Why: ${p.why}`);
        out.push(`   Confidence: ${p.confidence}`);
        if (p.next) out.push(`   Next: ${p.next}`);
        out.push('');
        chips.push(`${p.title.split('—')[0].trim()}: ${p.confidence}`);
      });
      document.getElementById(containerId).textContent = out.join('\n').trim() || '—';

      const chipEl = document.getElementById(chipsId);
      chipEl.innerHTML = '';
      chips.forEach(c => {
        const span = document.createElement('span');
        span.className = chipClassForText(c);
        span.textContent = c;
        chipEl.appendChild(span);
      });
    }

    function pfMid(indices) {
      return (Number.isFinite(indices.pfLow) && Number.isFinite(indices.pfHigh)) ? (indices.pfLow + indices.pfHigh)/2 : NaN;
    }

    function buildPlanA({context, pH, PaCO2, indices, rr, targetSpO2}) {
      const plan = [];
      const hypercap = Number.isFinite(PaCO2) && PaCO2 > 45;
      const acidemic = Number.isFinite(pH) && pH < 7.35;
      const severeAcid = Number.isFinite(pH) && pH < 7.25;
      const pf = pfMid(indices);
      const hypox = Number.isFinite(pf) && pf < 200;

      // Defaults for specificity
      const copdTarget = /88-92/.test(targetSpO2);

      // 1) COPD / hypercapnic acidemia -> BiPAP
      if ((context === 'copd') || (hypercap && acidemic)) {
        const start = severeAcid ? 'IPAP 14–16 / EPAP 4–5' : 'IPAP 12–14 / EPAP 4–5';
        plan.push({
          title: 'BiPAP (NIV, S/T if available) — primary choice',
          settings: `${start}; FiO₂ titrate to SpO₂ ${targetSpO2}. Typical ceiling: IPAP 20–24, EPAP 6–8 (tolerability/air leak dependent).`,
          why: `Hypercapnia + acidemia suggests ventilatory failure. Pressure support (IPAP-EPAP) improves CO₂ clearance; EPAP helps offset intrinsic PEEP.`,
          confidence: (context === 'copd') ? 'STRONG (best-established indication: AECOPD hypercapnic acidosis)' : 'MODERATE (hypercapnic acidosis outside COPD)',
          next: 'Recheck ABG ~60–120 min after initiation or earlier if deteriorating; adjust IPAP +2–3 if PaCO₂ not falling or pH not rising.'
        });

        // Alternative: HFNC only if NIV not tolerated
        plan.push({
          title: 'HFNC — alternative if NIV not tolerated',
          settings: `Flow 30–45 L/min; FiO₂ to target SpO₂ ${targetSpO2}.`,
          why: `HFNC can reduce dead-space and work of breathing but is less effective than NIV for ventilatory failure.`,
          confidence: 'WEAK–MODERATE (supportive; not a substitute for NIV in clear hypercapnic failure)',
          next: 'If pH falls or PaCO₂ rises: escalate back to NIV or higher-level support.'
        });

        return plan;
      }

      // 2) Cardiogenic pulmonary edema -> CPAP first-line unless hypercapnic
      if (context === 'cardio') {
        plan.push({
          title: 'CPAP — primary choice',
          settings: `Start CPAP 8–10 cmH₂O; FiO₂ to SpO₂ ${targetSpO2}. Titrate CPAP +2 (typical 10–12, max ~15) if persistent distress/hypoxemia.`,
          why: `Continuous pressure improves alveolar recruitment and reduces preload/afterload in CPO.`,
          confidence: 'STRONG (common evidence-based application)',
          next: 'Assess response within 30–60 min: RR, dyspnea, SpO₂, and repeat gas if needed.'
        });

        // If hypercapnia present, BiPAP
        if (hypercap) {
          plan.push({
            title: 'BiPAP — if hypercapnia accompanies CPO',
            settings: `Start IPAP 12–14 / EPAP 6–8; FiO₂ to target.`,
            why: `Adds ventilatory support (pressure support) when CO₂ retention is present in addition to oxygenation/recruitment needs.`,
            confidence: 'MODERATE',
            next: 'Recheck ABG in ~1 h; titrate IPAP +2 if PaCO₂ not improving.'
          });
        }
        return plan;
      }

      // 3) Hypoxemic failure (pneumonia/ARDS-like): HFNC first (if not needing immediate intubation)
      if (context === 'hypox' || hypox) {
        plan.push({
          title: 'HFNC — primary choice',
          settings: `Start Flow 50–60 L/min; start FiO₂ 0.5–0.7 then titrate to SpO₂ ${targetSpO2}.`,
          why: `High flow provides more stable FiO₂, dead-space washout, and small PEEP effect; often improves comfort and oxygenation.`,
          confidence: 'MODERATE–STRONG (widely recommended for acute hypoxemic respiratory failure)',
          next: 'If FiO₂ requirement stays high (>0.6) or distress persists, consider CPAP/PEEP trial or escalation.'
        });

        plan.push({
          title: 'CPAP — alternative / escalation step',
          settings: `Start CPAP 8–10 cmH₂O; titrate +2 to 12–15 if oxygenation remains poor; FiO₂ as needed.`,
          why: `Recruitment/PEEP can be more effective when shunt-like physiology dominates.`,
          confidence: 'MODERATE',
          next: 'Repeat ABG or reassess within 30–60 min; plan escalation early if failing.'
        });

        return plan;
      }

      // 4) Metabolic/lactic acidosis: treat cause; support oxygenation; avoid suppressing compensatory ventilation
      if (context === 'metabolic') {
        plan.push({
          title: 'Primary therapy — treat cause (not ventilator settings)',
          settings: `Resuscitation/antibiotics/source control as appropriate; oxygen to SpO₂ ${targetSpO2}.`,
          why: `In lactic/metabolic acidosis the key problem is metabolic; respiratory alkalosis may be compensatory.`,
          confidence: 'STRONG (principle-based, standard practice)',
          next: 'Do not blunt compensatory ventilation; monitor fatigue and rising PaCO₂.'
        });

        plan.push({
          title: 'HFNC — if high work of breathing but oxygenation needed',
          settings: `Flow 40–60 L/min; FiO₂ titrate to SpO₂ ${targetSpO2}.`,
          why: `Reduces work of breathing while allowing high minute ventilation (compensation).`,
          confidence: 'MODERATE',
          next: 'If tiring, altered mental state, rising PaCO₂, or worsening acidosis → escalate early.'
        });

        plan.push({
          title: 'BiPAP — only if ventilatory fatigue/hypercapnia emerges',
          settings: `Start IPAP 10–12 / EPAP 4–5 (avoid excessive EPAP); titrate IPAP +2 to support ventilation while preserving high RR if needed.`,
          why: `May unload work of breathing, but must avoid reducing compensatory ventilation.`,
          confidence: 'WEAK–MODERATE (case-by-case)',
          next: 'Repeat gas within 30–60 min; escalate if mental state or gas exchange worsens.'
        });

        return plan;
      }

      // 5) Asthma: cautious
      if (context === 'asthma') {
        plan.push({
          title: 'NIV trial — selected patients only',
          settings: `Start IPAP 10–12 / EPAP 4–5; short trial with close monitoring; FiO₂ to target.`,
          why: `May reduce work of breathing, but evidence is mixed and risk of delayed intubation exists.`,
          confidence: 'WEAK',
          next: 'Low threshold for escalation if fatigue, silent chest, worsening acidosis, or reduced consciousness.'
        });

        plan.push({
          title: 'HFNC — supportive alternative',
          settings: `Flow 40–60 L/min; FiO₂ to target.`,
          why: `Comfort + stable FiO₂; does not provide true ventilatory support.`,
          confidence: 'WEAK–MODERATE',
          next: 'Escalate if worsening ventilation/acidemia.'
        });

        return plan;
      }

      // fallback
      plan.push({
        title: 'Support choice unclear from ABG alone',
        settings: `Titrate oxygen to SpO₂ ${targetSpO2}. Consider HFNC (Flow 40–60, FiO₂ titrate) if distressed; consider NIV/CPAP based on clinical work of breathing.`,
        why: `ABG must be interpreted with clinical context (work of breathing, consciousness, hemodynamics).`,
        confidence: 'MODERATE',
        next: 'Repeat gas if therapy changes or patient deteriorates.'
      });

      return plan;
    }

    function analyseA() {
      const units = document.getElementById('units').value;
      const pH = num('pH_A');
      const PaCO2 = toMmHg(num('PaCO2_A'), units);
      const PaO2 = toMmHg(num('PaO2_A'), units);
      const HCO3 = num('HCO3_A');
      const RR = num('RR_A');
      const SpO2 = num('SpO2_A');

      const device = document.getElementById('deviceA').value;
      const flowFi = num('flowFiO2A');
      const FiO2 = estimateFiO2(device, flowFi);

      const indices = calcOxygenation(PaO2, PaCO2, FiO2.min, FiO2.max);
      const acid = analyseAcidBase(pH, PaCO2, HCO3);
      const ag = calcAnionGap(num('Na_A'), num('Cl_A'), HCO3, num('Alb_A'));
      const hacor = calcHACOR(num('HR_A'), pH, num('GCS_A'), RR, PaO2, FiO2.min, FiO2.max);

      const targetSpO2 = getTargetSpO2Text();

      const lines = [];
      lines.push(`SpO₂ target: ${targetSpO2}`);
      lines.push(`FiO₂ estimate: ${Number.isFinite(FiO2.min) ? (FiO2.min * 100).toFixed(0) : '—'}–${Number.isFinite(FiO2.max) ? (FiO2.max * 100).toFixed(0) : '—'}% (${FiO2.info})`);
      if (device === 'hfnc') {
        const f = num('hfncFlowA');
        lines.push(`HFNC flow at ABG: ${Number.isFinite(f) ? f.toFixed(0)+' L/min' : '—'}`);
      }
      if (Number.isFinite(indices.pfLow)) lines.push(`P/F: ${indices.pfLow.toFixed(0)}–${indices.pfHigh.toFixed(0)} mmHg`);
      if (Number.isFinite(indices.AAGmin)) lines.push(`A–a: ${indices.AAGmin.toFixed(0)}–${indices.AAGmax.toFixed(0)} mmHg`);
      if (Number.isFinite(indices.aAmin)) lines.push(`a/A: ${indices.aAmin.toFixed(2)}–${indices.aAmax.toFixed(2)}`);
      lines.push('');
      lines.push(acid.text);
      if (ag) lines.push(`Anion gap: ${ag.ag.toFixed(1)}${Number.isFinite(ag.agCorr) && ag.agCorr !== ag.ag ? ` (albumin-corrected ${ag.agCorr.toFixed(1)})` : ''}`);
      if (hacor) lines.push(`HACOR score: ${hacor.total} (higher risk if >5)`);
      document.getElementById('resultA').textContent = lines.join('\n');

      const flags = [...acid.flags];
      const pf = pfMid(indices);
      if (Number.isFinite(pf) && pf < 150) flags.push('Low P/F (<150)');
      if (Number.isFinite(PaO2) && PaO2 < 55) flags.push('PaO₂ < 55');
      if (Number.isFinite(RR) && RR > 30) flags.push('RR > 30');
      const lac = num('Lac_A');
      if (Number.isFinite(lac) && lac >= 2) flags.push('Lactate ≥2');
      if (hacor && hacor.total > 5) flags.push('HACOR > 5 (higher failure risk)');
      renderChips('flagsA', flags);

      const ctx = document.getElementById('contextA').value;
      const plan = buildPlanA({context: ctx, pH, PaCO2, indices, rr: RR, targetSpO2});
      renderSupportPlan('supportA', 'supportChipsA', plan);

      renderChips('indicesA', [
        Number.isFinite(pf) ? `P/F mid ≈ ${pf.toFixed(0)}` : 'P/F unknown',
        FiO2.info,
        (hacor ? `HACOR ${hacor.total}` : 'HACOR n/a')
      ]);

      baselineData = {
        ctx, targetSpO2, pH, PaCO2, PaO2, HCO3, RR, SpO2,
        FiO2, indices, acid, ag, hacor, flags, plan,
        note: document.getElementById('noteA').value
      };

      document.getElementById('resultB').textContent = 'Complete Section A first. Enter repeat ABG and click “Analyse B”.';
      document.getElementById('flagsB').innerHTML = '';
      document.getElementById('vqB').textContent = 'Will summarise patterns once both ABGs are analysed.';
      document.getElementById('summary').textContent = 'Baseline analysed. Perform Section B to build a summary.';
      repeatData = null;
    }

    function analyseB() {
      if (!baselineData) { alert('Please analyse Section A first.'); return; }

      const units = document.getElementById('units').value;
      const mins = num('minsB');
      const pH = num('pH_B');
      const PaCO2 = toMmHg(num('PaCO2_B'), units);
      const PaO2 = toMmHg(num('PaO2_B'), units);
      const HCO3 = num('HCO3_B');
      const RR = num('RR_B');
      const SpO2 = num('SpO2_B');
      const lactate = num('Lac_B');

      const FiInput = num('FiO2_B');
      const FiB = Number.isFinite(FiInput)
        ? { min: Math.min(1, Math.max(0.21, FiInput / 100)), max: Math.min(1, Math.max(0.21, FiInput / 100)), info: 'Set FiO₂ (B)' }
        : baselineData.FiO2;

      const indices = calcOxygenation(PaO2, PaCO2, FiB.min, FiB.max);
      const acid = analyseAcidBase(pH, PaCO2, HCO3);
      const hacor = calcHACOR(num('HR_B'), pH, num('GCS_B'), RR, PaO2, FiB.min, FiB.max);

      const therapy = document.getElementById('therapyB').value;
      const hfncFlowB = num('hfncFlowB');
      const targetSpO2 = baselineData.targetSpO2;

      const flags = [];
      if (Number.isFinite(mins) && mins >= 30) {
        if (Number.isFinite(baselineData.pH) && Number.isFinite(pH) && pH <= baselineData.pH) flags.push('No pH improvement');
        if (Number.isFinite(baselineData.PaCO2) && Number.isFinite(PaCO2) && PaCO2 >= baselineData.PaCO2) flags.push('PaCO₂ not improving');
        if (Number.isFinite(baselineData.RR) && Number.isFinite(RR) && RR >= baselineData.RR) flags.push('RR not improving');
      }
      if (Number.isFinite(RR) && RR > 25) flags.push('RR > 25');
      if (Number.isFinite(pH) && pH < 7.20) flags.push('pH < 7.20');
      if (hacor && hacor.total > 5) flags.push('HACOR > 5 (higher failure risk)');
      if (Number.isFinite(lactate) && lactate >= 2) flags.push('Elevated lactate');

      const suggestions = [];
      const pf = pfMid(indices);
      const pfBase = pfMid(baselineData.indices);

      function addSuggestion(title, settings, why, confidence) {
        suggestions.push({title, settings, why, confidence});
      }

      // Therapy-specific titration
      if (therapy === 'niv') {
        if (Number.isFinite(PaCO2) && Number.isFinite(baselineData.PaCO2) && PaCO2 >= baselineData.PaCO2) {
          addSuggestion(
            'Increase IPAP (pressure support)',
            'Increase IPAP by +2–3 cmH₂O (keep EPAP same); reassess comfort/leak.',
            'PaCO₂ not improving suggests inadequate ventilation; increasing pressure support improves CO₂ clearance.',
            'MODERATE'
          );
        }
        if (Number.isFinite(pf) && pf < 150) {
          addSuggestion(
            'Improve oxygenation (EPAP/FiO₂)',
            'Increase FiO₂ first; if still low SpO₂/PF, increase EPAP by +1–2 and also raise IPAP to maintain the same ΔP.',
            'Low PF suggests shunt/V-Q mismatch; EPAP/PEEP recruits alveoli while FiO₂ increases delivered oxygen.',
            'MODERATE'
          );
        }
      } else if (therapy === 'cpap') {
        if (Number.isFinite(pf) && pf < 200) {
          addSuggestion(
            'Increase CPAP',
            'Increase CPAP by +2 cmH₂O (typical 10–12, up to ~15) and titrate FiO₂ to target.',
            'Persistent hypoxemia on CPAP suggests under-recruitment; more pressure can improve alveolar recruitment.',
            'MODERATE'
          );
        }
      } else if (therapy === 'hfnc') {
        if (Number.isFinite(RR) && RR > 25) {
          addSuggestion(
            'Increase HFNC flow',
            'Increase flow toward 60 L/min (or +5–10 L/min) if tolerated; maintain humidification.',
            'Higher flow reduces work of breathing and improves stability of FiO₂.',
            'MODERATE–STRONG'
          );
        }
        addSuggestion(
          'Adjust FiO₂',
          `Titrate FiO₂ to maintain SpO₂ ${targetSpO2}. If FiO₂ >0.6 and no improvement, consider escalation.`,
          'High FiO₂ requirement with poor response suggests more severe V/Q mismatch or shunt physiology.',
          'MODERATE'
        );
      } else {
        // Oxygen masks etc
        addSuggestion(
          'Oxygen titration',
          `Adjust FiO₂/flow to keep SpO₂ ${targetSpO2}; reassess device fit and seal.`,
          'Poor fit/leak causes delivered FiO₂ to be lower than expected.',
          'MODERATE'
        );
      }

      // Global “failing trial” pattern
      if (Number.isFinite(pfBase) && Number.isFinite(pf) && (pf - pfBase) < 20 && Number.isFinite(mins) && mins >= 60) {
        addSuggestion(
          'Escalation planning',
          'Minimal improvement after ~1 hour → check mask leak, secretion load, fatigue; consider higher-level support/ICU review.',
          'Early non-response is a common predictor of failure for non-invasive strategies.',
          'MODERATE'
        );
      }

      // Metabolic/lactic context reinforcement
      if (baselineData.ctx === 'metabolic' && Number.isFinite(lactate) && lactate >= 2) {
        addSuggestion(
          'Treat metabolic driver',
          'Prioritise shock/sepsis management (fluids/pressors, antibiotics, source control as appropriate). Maintain compensatory ventilation.',
          'Ventilation support doesn’t fix lactic acidosis; underlying perfusion/oxygen delivery must be corrected.',
          'STRONG'
        );
      }

      // Render Section B result text
      const out = [];
      out.push(`Time on therapy: ${Number.isFinite(mins) ? mins.toFixed(0)+' min' : '—'}`);
      out.push(`ABG B: pH ${Number.isFinite(pH)?pH.toFixed(2):'—'}, PaCO₂ ${Number.isFinite(PaCO2)?PaCO2.toFixed(1):'—'}, PaO₂ ${Number.isFinite(PaO2)?PaO2.toFixed(1):'—'}, HCO₃ ${Number.isFinite(HCO3)?HCO3.toFixed(1):'—'}`);
      out.push(`FiO₂ used: ${Number.isFinite(FiB.min)?(FiB.min*100).toFixed(0)+'%':'—'}`);
      if (therapy === 'hfnc') out.push(`HFNC flow: ${Number.isFinite(hfncFlowB) ? hfncFlowB.toFixed(0)+' L/min' : '—'}`);
      if (Number.isFinite(pf)) out.push(`P/F mid ≈ ${pf.toFixed(0)} mmHg`);
      out.push('');
      out.push(acid.text);
      if (hacor) out.push(`HACOR: ${hacor.total} (higher risk if >5)`);
      out.push('');
      out.push('Specific suggestions (WHAT + WHY + CONFIDENCE):');
      suggestions.forEach((s, i) => {
        out.push(`${i+1}) ${s.title}`);
        out.push(`   What: ${s.settings}`);
        out.push(`   Why: ${s.why}`);
        out.push(`   Confidence: ${s.confidence}`);
      });
      document.getElementById('resultB').textContent = out.join('\n');

      renderChips('flagsB', flags);

      // V/Q vs shunt heuristic (simple)
      const vq = [];
      const vqFlags = [];
      if (Number.isFinite(pf) && pf < 150) vqFlags.push('Very low P/F → shunt-like physiology likely.');
      if (Number.isFinite(baselineData.indices.AAGmin) && Number.isFinite(indices.AAGmin)) {
        const deltaAA = indices.AAGmin - baselineData.indices.AAGmin;
        if (deltaAA > 20) vq.push('Rising A–a gradient → worsening V/Q mismatch/shunt; consider recruitment (EPAP/PEEP) + escalation.');
        else vq.push('A–a gradient stable → less shunt progression; consider ventilation/drive or device factors.');
      } else {
        vq.push('V/Q heuristic needs FiO₂ + PaO₂ + PaCO₂ to estimate A–a and P/F.');
      }
      document.getElementById('vqB').textContent = vq.join('\n');
      renderChips('chipsB', vqFlags);

      repeatData = { mins, therapy, pH, PaCO2, PaO2, HCO3, RR, SpO2, lactate, FiB, indices, acid, hacor, flags, suggestions };
      updateSummary();
    }

    function updateSummary() {
      if (!baselineData) { document.getElementById('summary').textContent = 'Perform Sections A and B to generate summary.'; return; }
      const sum = [];
      sum.push('Baseline assessment:');
      sum.push(`Context: ${baselineData.ctx}. SpO₂ target: ${baselineData.targetSpO2}.`);
      sum.push(`FiO₂ estimate: ${Number.isFinite(baselineData.FiO2.min) ? (baselineData.FiO2.min*100).toFixed(0) : '—'}–${Number.isFinite(baselineData.FiO2.max) ? (baselineData.FiO2.max*100).toFixed(0) : '—'}% (${baselineData.FiO2.info}).`);
      sum.push(`ABG A: pH ${baselineData.pH ?? '—'}, PaCO₂ ${baselineData.PaCO2 ?? '—'}, PaO₂ ${baselineData.PaO2 ?? '—'}, HCO₃ ${baselineData.HCO3 ?? '—'}.`);
      const pfA = pfMid(baselineData.indices);
      if (Number.isFinite(pfA)) sum.push(`P/F mid ≈ ${pfA.toFixed(0)}.`);
      sum.push('');
      sum.push('Baseline support plan:');
      baselineData.plan.forEach((p, i) => {
        sum.push(`${i+1}) ${p.title} — ${p.settings}`);
        sum.push(`   Why: ${p.why}`);
        sum.push(`   Confidence: ${p.confidence}`);
      });
      sum.push('');
      sum.push(`Baseline flags: ${baselineData.flags.length ? baselineData.flags.join('; ') : 'None'}.`);

      if (repeatData) {
        sum.push('');
        sum.push('Repeat ABG & response:');
        sum.push(`After ${Number.isFinite(repeatData.mins)?repeatData.mins+' min':'—'} on ${repeatData.therapy}.`);
        sum.push(`ABG B: pH ${repeatData.pH ?? '—'}, PaCO₂ ${repeatData.PaCO2 ?? '—'}, PaO₂ ${repeatData.PaO2 ?? '—'}, HCO₃ ${repeatData.HCO3 ?? '—'}.`);
        const pfB = pfMid(repeatData.indices);
        if (Number.isFinite(pfB)) sum.push(`P/F mid ≈ ${pfB.toFixed(0)}.`);
        sum.push(`Trend flags: ${repeatData.flags.length ? repeatData.flags.join('; ') : 'None'}.`);
        sum.push('');
        sum.push('Recommendations going forwards:');
        repeatData.suggestions.forEach((s, i) => {
          sum.push(`${i+1}) ${s.title} (Confidence: ${s.confidence})`);
          sum.push(`   What: ${s.settings}`);
          sum.push(`   Why: ${s.why}`);
        });
      } else {
        sum.push('');
        sum.push('Complete Section B to summarise response and next steps.');
      }

      document.getElementById('summary').textContent = sum.join('\n');
    }

    function copySummary() {
      navigator.clipboard.writeText(document.getElementById('summary').textContent).then(() => alert('Summary copied to clipboard.'));
    }

    // Examples / clear
    function fillExampleA() {
      clearA();
      document.getElementById('contextA').value = 'copd';
      document.getElementById('targetSpO2').value = '88-92';
      document.getElementById('deviceA').value = 'nc';
      handleDeviceChangeA();
      document.getElementById('flowFiO2A').value = 2;
      document.getElementById('pH_A').value = 7.28;
      document.getElementById('PaCO2_A').value = 68;
      document.getElementById('PaO2_A').value = 55;
      document.getElementById('HCO3_A').value = 28;
      document.getElementById('RR_A').value = 28;
      document.getElementById('SpO2_A').value = 88;
      document.getElementById('Lac_A').value = 1.2;
      document.getElementById('HR_A').value = 110;
      document.getElementById('GCS_A').value = 15;
    }

    function fillExampleB() {
      clearB();
      document.getElementById('minsB').value = 60;
      document.getElementById('therapyB').value = 'niv';
      handleTherapyChangeB();
      document.getElementById('settingsB').value = 'IPAP 14 / EPAP 5';
      document.getElementById('FiO2_B').value = 28;
      document.getElementById('pH_B').value = 7.32;
      document.getElementById('PaCO2_B').value = 60;
      document.getElementById('PaO2_B').value = 70;
      document.getElementById('HCO3_B').value = 30;
      document.getElementById('RR_B').value = 24;
      document.getElementById('SpO2_B').value = 92;
      document.getElementById('Lac_B').value = 1.8;
      document.getElementById('HR_B').value = 105;
      document.getElementById('GCS_B').value = 15;
    }

    function clearA() {
      ['pH_A','PaCO2_A','PaO2_A','HCO3_A','RR_A','SpO2_A','flowFiO2A','noteA','Na_A','Cl_A','Alb_A','Lac_A','HR_A','GCS_A','heightA','hfncFlowA'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('resultA').textContent = 'Enter Section A and click “Analyse A”.';
      document.getElementById('supportA').textContent = 'Will populate with: WHAT + WHY + CONFIDENCE.';
      document.getElementById('indicesA').innerHTML = '';
      document.getElementById('flagsA').innerHTML = '';
      document.getElementById('supportChipsA').innerHTML = '';
      baselineData = null;
      updateSummary();
    }

    function clearB() {
      ['minsB','pH_B','PaCO2_B','PaO2_B','HCO3_B','RR_B','SpO2_B','FiO2_B','settingsB','Lac_B','HR_B','GCS_B','hfncFlowB'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('resultB').textContent = 'Complete Section A first. Enter repeat ABG and click “Analyse B”.';
      document.getElementById('flagsB').innerHTML = '';
      document.getElementById('chipsB').innerHTML = '';
      document.getElementById('vqB').textContent = 'Will summarise patterns once both ABGs are analysed.';
      repeatData = null;
      updateSummary();
    }

    // Initialize toggles
    handleDeviceChangeA();
    handleTherapyChangeB();
  </script>
</body>
</html>
