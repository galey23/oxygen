<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ABG/NIV Helper</title>
<style>
  /* compact styling omitted for brevity – use your existing CSS */
</style>
</head>
<body>
<div id="sectionA">
  <h2>Section A: Baseline ABG</h2>
  <!-- inputs for ABG A: pH, PaCO₂, PaO₂, HCO₃⁻, RR, SpO₂, device, flow/FiO₂ etc. -->
  <button id="btnAnalyseA">Analyse A</button>
  <pre id="resultA"></pre>
  <pre id="nivA"></pre>
  <pre id="flagsA"></pre>
</div>

<div id="sectionB">
  <h2>Section B: Repeat ABG</h2>
  <!-- inputs for ABG B: time on therapy, pH, PaCO₂, PaO₂, etc. -->
  <button id="btnAnalyseB">Analyse B</button>
  <pre id="resultB"></pre>
  <pre id="flagsB"></pre>
</div>

<div id="sectionSummary">
  <h2>Summary</h2>
  <pre id="summary"></pre>
</div>

<script>
// helper: parse numeric input or return NaN
function getNum(id){ const v=document.getElementById(id).value; return v?parseFloat(v):NaN; }

// estimate FiO₂ from device and flow
function estimateFiO2(device, flowFi){
  if(device==='ra') return {min:0.21,max:0.21,info:'Room air'};
  if(!isFinite(flowFi)) return {min:NaN,max:NaN,info:'No flow/FiO₂'};
  if(flowFi>=22){ const f=Math.min(1,Math.max(0.21,flowFi/100)); return {min:f,max:f,info:'Set FiO₂'}; }
  const L=flowFi;
  if(device==='nc')   return {min:0.21+0.03*L,max:0.21+0.04*L,info:'NC'};
  if(device==='simple') return {min:0.28+0.01*(L-6),max:0.40+0.02*(L-6),info:'Simple mask'};
  if(device==='nrb')    return {min:0.60+0.01*(L-10),max:0.80+0.02*(L-10),info:'NRB'};
  return {min:NaN,max:NaN,info:'Set FiO₂'};
}

// compute P/F ratio, A–a gradient, a/A ratio
function calcIndices(PaO2,PaCO2,FiMin,FiMax,SpO2){
  const pfLow  = isFinite(PaO2)&&isFinite(FiMax)?PaO2/FiMax:NaN;
  const pfHigh = isFinite(PaO2)&&isFinite(FiMin)?PaO2/FiMin:NaN;
  // alveolar gas equation
  let AAGmin=NaN,AAGmax=NaN,aAmin=NaN,aAmax=NaN;
  if(isFinite(PaO2)&&isFinite(PaCO2)&&isFinite(FiMin)&&isFinite(FiMax)){
    const calc=(Fi,pCO2)=>Fi*(760-47) - pCO2/0.8;
    const PAmid=calc((FiMin+FiMax)/2,PaCO2);
    const Aa = PAmid - PaO2;
    const aA = PaO2 / PAmid;
    const PAmin = calc(FiMin,PaCO2);
    const PAmax = calc(FiMax,PaCO2);
    AAGmin = Math.min(PAmin-PaO2,PAmax-PaO2);
    AAGmax = Math.max(PAmin-PaO2,PAmax-PaO2);
    aAmin  = Math.min(PaO2/PAmin,PaO2/PAmax);
    aAmax  = Math.max(PaO2/PAmin,PaO2/PAmax);
  }
  return {pfLow,pfHigh,AAGmin,AAGmax,aAmin,aAmax};
}

// acid–base interpretation with compensation checks
function analyseAcidBase(pH,pCO2,HCO3){
  if(![pH,pCO2,HCO3].every(isFinite)) return {text:'Need pH, PaCO₂, HCO₃⁻',flags:[]};
  const lines=[];
  const flags=[];
  if(pH<7.35){
    if(pCO2>45 && HCO3>=22) lines.push('Primary respiratory acidosis');
    else if(HCO3<22 && pCO2<=45) lines.push('Primary metabolic acidosis');
    else lines.push('Mixed metabolic + respiratory acidosis');
  } else if(pH>7.45){
    if(pCO2<35 && HCO3<=26) lines.push('Primary respiratory alkalosis');
    else if(HCO3>26 && pCO2>=35) lines.push('Primary metabolic alkalosis');
    else lines.push('Mixed metabolic + respiratory alkalosis');
  } else {
    lines.push('Compensated or mixed disorder');
  }
  if(pH<7.25) flags.push('pH < 7.25');
  if(pCO2>60) flags.push('PaCO₂ > 60');
  return {text:lines.join('\n'),flags};
}

// handle Analyse A
function analyseA(){
  // get FiO₂ range
  const dev = document.getElementById('deviceA').value;
  const flow = getNum('flowFiO2A');
  const FiO2 = estimateFiO2(dev,flow);
  const units = document.getElementById('units').value;
  const conv = v => units==='kpa' ? v*7.50062 : v;
  const pH   = getNum('pH_A');
  const PaCO2 = conv(getNum('PaCO2_A'));
  const PaO2  = conv(getNum('PaO2_A'));
  const HCO3 = getNum('HCO3_A');
  const RR   = getNum('RR_A');
  const SpO2 = getNum('SpO2_A');
  // compute indices
  const idx = calcIndices(PaO2,PaCO2,FiO2.min,FiO2.max,SpO2);
  const acid = analyseAcidBase(pH,PaCO2,HCO3);
  // output result
  const result = [];
  result.push(`FiO₂: ${isFinite(FiO2.min)?(FiO2.min*100).toFixed(0)+'–'+(FiO2.max*100).toFixed(0)+'%':'unknown'}`);
  if(isFinite(idx.pfLow)) result.push(`P/F: ${idx.pfLow.toFixed(0)}–${idx.pfHigh.toFixed(0)} mmHg`);
  if(isFinite(idx.AAGmin)) result.push(`A–a: ${idx.AAGmin.toFixed(0)}–${idx.AAGmax.toFixed(0)} mmHg`);
  if(isFinite(idx.aAmin)) result.push(`a/A: ${idx.aAmin.toFixed(2)}–${idx.aAmax.toFixed(2)}`);
  result.push('');
  result.push(acid.text);
  document.getElementById('resultA').textContent = result.join('\n');
  // NIV suggestions
  const suggestions = [];
  const hypercap = PaCO2 > 45;
  const acidemia = pH < 7.35;
  const hypox    = PaO2 < 60;
  if(hypercap && acidemia){
    suggestions.push('BiPAP/NIV: start IPAP 10–12 cmH₂O, EPAP 4–5 cmH₂O.');
    suggestions.push('Titrate IPAP +2–3 if PaCO₂ remains high or pH remains acidotic.');
    suggestions.push('Increase EPAP/FiO₂ for oxygenation if needed.');
  } else if(hypox && !hypercap){
    suggestions.push('CPAP or HFNC: start CPAP 5–10 cmH₂O.');
    suggestions.push('If using BiPAP for oxygenation: EPAP 5–10, PS 5–10.');
  } else {
    suggestions.push('No specific NIV mode indicated; base decision on clinical picture.');
  }
  document.getElementById('nivA').textContent = suggestions.join('\n');
  // Flags and chips
  const flags = [...acid.flags];
  if(isFinite(idx.pfLow) && idx.pfLow < 150) flags.push('Low P/F (<150)');
  document.getElementById('flagsA').textContent = flags.join('\n') || '—';
  const chipContainer = document.getElementById('chipsA');
  chipContainer.innerHTML='';
  flags.forEach(f=>{
    let tone='warn-chip';
    if(f.includes('pH < 7.25') || f.includes('<150')) tone='bad-chip';
    const span=document.createElement('span');
    span.className='chip '+tone;
    span.textContent=f;
    chipContainer.appendChild(span);
  });
  // store baseline
  baselineData = {pH,PaCO2,PaO2,HCO3,RR,SpO2,FiO2,idx,acid,suggestions,flags};
  // clear previous Section B results
  document.getElementById('resultB').textContent='Complete Section B inputs and click “Analyse B”.';
  document.getElementById('flagsB').textContent='—';
  document.getElementById('summary').textContent='Baseline analysed. Complete Section B to see recommendations.';
  repeatData = null;
}

// handle Analyse B
function analyseB(){
  if(!baselineData){ alert('Please analyse Section A first.'); return; }
  const mins = getNum('minsB');
  const setFi = getNum('FiO2_B');
  let FiB;
  if(isFinite(setFi)){
    const f=Math.min(1,Math.max(0.21,setFi/100)); FiB={min:f,max:f};
  }else FiB=baselineData.FiO2;
  const units=document.getElementById('units').value;
  const conv = v => units==='kpa' ? v*7.50062 : v;
  const pH  = getNum('pH_B');
  const PaCO2=conv(getNum('PaCO2_B'));
  const PaO2=conv(getNum('PaO2_B'));
  const HCO3 = getNum('HCO3_B');
  const RR  = getNum('RR_B');
  const SpO2= getNum('SpO2_B');
  const LacB= getNum('Lac_B');
  const HRB= getNum('HR_B');
  const GCSB=getNum('GCS_B');
  // Indices
  const idxB=calcIndices(PaO2,PaCO2,FiB.min,FiB.max,SpO2);
  const acidB=analyseAcidBase(pH,PaCO2,HCO3);
  const hacB=calcHACOR(HRB,pH,GCSB,RR,PaO2,FiB.min,FiB.max);
  // Flags for failing trial
  let flagsB=[];
  if(isFinite(mins) && mins>=30 && mins<=240){
    if(isFinite(baselineData.pH) && isFinite(pH) && pH<=baselineData.pH) flagsB.push('No pH improvement');
    if(isFinite(baselineData.PaCO2) && isFinite(PaCO2) && PaCO2>=baselineData.PaCO2) flagsB.push('PaCO₂ not improving');
    if(isFinite(baselineData.RR) && isFinite(RR) && RR>=baselineData.RR) flagsB.push('RR not improving');
  }
  if(isFinite(RR)&&RR>25) flagsB.push('RR > 25');
  if(isFinite(pH)&&pH<7.20) flagsB.push('pH < 7.20');
  if(hacB&&hacB.max>5) flagsB.push('HACOR > 5');
  // suggestions based on trend
  const suggestions=[];
  if(isFinite(PaCO2) && isFinite(baselineData.PaCO2) && PaCO2>=baselineData.PaCO2){
    suggestions.push('Increase IPAP by 2–3 cmH₂O (if on BiPAP)');
  }
  if(isFinite(idxB.pfLow) && idxB.pfLow<150){
    suggestions.push('Increase EPAP/PEEP by 1–2 cmH₂O and/or FiO₂');
  }
  if(isFinite(LacB) && LacB>=2){
    suggestions.push('High lactate: treat underlying cause (e.g., sepsis, shock) and support ventilation');
  }
  if(!suggestions.length) suggestions.push('Continue current support and reassess frequently');
  // response lines
  const lines=[];
  lines.push(`After ${isFinite(mins)?mins+' min':'unknown'}:`);
  lines.push(`pH: ${isFinite(pH)?pH.toFixed(2):'—'}, PaCO₂: ${isFinite(PaCO2)?PaCO2.toFixed(1)+' mmHg':'—'}, PaO₂: ${isFinite(PaO2)?PaO2.toFixed(1)+' mmHg':'—'}`);
  if(isFinite(idxB.pfLow)) lines.push(`P/F: ${idxB.pfLow.toFixed(0)}–${idxB.pfHigh.toFixed(0)} mmHg`);
  lines.push('');
  lines.push(acidB.text);
  lines.push('');
  suggestions.forEach(s=>lines.push('→ '+s));
  document.getElementById('resultB').textContent = lines.join('\n');
  document.getElementById('flagsB').textContent = flagsB.join('\n') || '—';
  // store repeat
  repeatData = {mins,pH,PaCO2,PaO2,HCO3,RR,SpO2,LacB,HRB,GCSB,FiB,idxB,acidB,hacB,flagsB,suggestions};
  updateSummary();
}

// update summary
function updateSummary(){
  if(!baselineData){ document.getElementById('summary').textContent='Perform Sections A and B to generate summary'; return; }
  let summary = [];
  summary.push('Baseline ABG:');
  summary.push(`pH ${baselineData.pH}, PaCO₂ ${baselineData.PaCO2}, PaO₂ ${baselineData.PaO2}, HCO₃ ${baselineData.HCO3}`);
  summary.push(`FiO₂: ${(baselineData.FiO2.min*100).toFixed(0)}–${(baselineData.FiO2.max*100).toFixed(0)}%`);
  summary.push(`P/F: ${baselineData.idx.pfLow.toFixed(0)}–${baselineData.idx.pfHigh.toFixed(0)} mmHg`);
  summary.push('');
  summary.push('Suggested NIV settings:');
  baselineData.suggestions.forEach(s=>summary.push('• '+s));
  summary.push('');
  summary.push('Flags at baseline: '+(baselineData.flags.length?baselineData.flags.join('; '):'None'));
  if(repeatData){
    summary.push('');
    summary.push('After therapy:');
    summary.push(`Time: ${isFinite(repeatData.mins)?repeatData.mins+' min':'unknown'}`);
    summary.push(`pH ${repeatData.pH}, PaCO₂ ${repeatData.PaCO2}, PaO₂ ${repeatData.PaO2}, HCO₃ ${repeatData.HCO3}`);
    summary.push(`P/F: ${repeatData.idxB.pfLow.toFixed(0)}–${repeatData.idxB.pfHigh.toFixed(0)}`);
    summary.push('');
    summary.push('Treatment suggestions:');
    repeatData.suggestions.forEach(s=>summary.push('• '+s));
    summary.push('');
    summary.push('Flags after repeat: '+(repeatData.flagsB.length?repeatData.flagsB.join('; '):'None'));
  }
  document.getElementById('summary').textContent = summary.join('\n');
}

// copy summary
function copySummary(){
  navigator.clipboard.writeText(document.getElementById('summary').textContent).then(()=>alert('Summary copied'));
}
</script>
</body>
</html>