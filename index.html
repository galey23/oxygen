<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ABG + O₂ → Interpretation + NIV Suggestions + Trend/VQ</title>
  <style>
    /* “Liquid glass” inspired UI (Apple-ish): translucent layers, blur, soft highlights */
    :root{
      --bg0:#06070b;
      --bg1:#070914;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.16);
      --stroke2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --faint: rgba(255,255,255,.50);
      --accent: rgba(110,198,255,.95);
      --accent2: rgba(170,120,255,.85);
      --good: rgba(116,255,192,.95);
      --warn: rgba(255,210,125,.95);
      --bad: rgba(255,110,110,.95);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 24px rgba(0,0,0,.35);
      --radius: 22px;
      --radius2: 16px;
      --pad: 16px;
      --pad2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 10% 5%, rgba(110,198,255,.18), transparent 55%),
        radial-gradient(1000px 650px at 90% 12%, rgba(170,120,255,.16), transparent 55%),
        radial-gradient(900px 600px at 20% 90%, rgba(116,255,192,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height: 100vh;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:22px;}
    .topbar{
      position: sticky; top:0; z-index:20;
      padding: 14px 0 10px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      background: linear-gradient(180deg, rgba(6,7,11,.85), rgba(6,7,11,.35));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .titleRow{display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;}
    h1{margin:0; font-size: 18px; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color: var(--muted); font-size: 12px;}
    .badgeRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      box-shadow: 0 8px 22px rgba(0,0,0,.22);
      font-size: 12px;
      color: var(--text);
    }
    .dot{width:8px; height:8px; border-radius:99px; background: var(--accent);}
    .dot.good{background: var(--good);}
    .dot.warn{background: var(--warn);}
    .dot.bad{background: var(--bad);}
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .tab{
      cursor:pointer; user-select:none;
      padding:10px 12px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 650;
      box-shadow: var(--shadow2);
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
    }
    .tab:hover{transform: translateY(-1px);}
    .tab.active{
      background: linear-gradient(180deg, rgba(110,198,255,.18), rgba(255,255,255,.06));
      border-color: rgba(110,198,255,.35);
    }

    .grid{display:grid; grid-template-columns: 1.15fr 1fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} .topbar{position:static;} }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: var(--pad);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: radial-gradient(900px 220px at 20% 0%, rgba(255,255,255,.12), transparent 60%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.9;
    }
    .card h2{margin:0 0 10px; font-size: 14px; color: rgba(255,255,255,.90); letter-spacing:.2px;}
    .muted{color: var(--muted); font-size: 12px; line-height:1.45;}
    .small{color: var(--faint); font-size: 11px; line-height:1.45;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;}
    @media (max-width: 680px){ .row,.row3{grid-template-columns:1fr;} }

    label{display:block; margin:10px 0 6px; font-size:12px; color: rgba(255,255,255,.78);}
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    textarea{min-height:74px; resize:vertical;}
    input::placeholder, textarea::placeholder{color: rgba(255,255,255,.35);}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(110,198,255,.85), rgba(110,198,255,.55));
      color: rgba(0,0,0,.86);
      font-weight: 800;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: 0 14px 34px rgba(110,198,255,.18), 0 10px 26px rgba(0,0,0,.35);
      transition: transform .15s ease, filter .2s ease;
    }
    button:hover{transform: translateY(-1px); filter: brightness(1.02);}
    button:active{transform: translateY(0px); filter: brightness(.98);}
    button.secondary{
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-color: rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,110,110,.95), rgba(255,110,110,.55));
      color: rgba(0,0,0,.86);
    }

    .divider{height:1px; background: rgba(255,255,255,.10); margin: 12px 0;}
    .panel{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .panel.good{border-color: rgba(116,255,192,.25); background: rgba(116,255,192,.08);}
    .panel.warn{border-color: rgba(255,210,125,.25); background: rgba(255,210,125,.08);}
    .panel.bad{border-color: rgba(255,110,110,.25); background: rgba(255,110,110,.08);}
    .mono{font-family: var(--mono); font-variant-numeric: tabular-nums; white-space: pre-wrap; line-height:1.45; font-size: 13px;}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: var(--text);
    }
    .chip.good{border-color: rgba(116,255,192,.25); color: var(--good);}
    .chip.warn{border-color: rgba(255,210,125,.25); color: var(--warn);}
    .chip.bad{border-color: rgba(255,110,110,.25); color: var(--bad);}

    .hidden{display:none !important;}
    .rightSticky{position:sticky; top:140px;}
    @media (max-width:980px){ .rightSticky{position:static;} }

    details{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding: 10px 12px;
      margin-top: 10px;
    }
    summary{cursor:pointer; font-weight:800; color: rgba(255,255,255,.88);}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="titleRow">
        <div>
          <h1>ABG + O₂ → Interpretation + NIV suggestions → Repeat ABG trend + V/Q heuristic</h1>
          <div class="sub">Educational decision-support. Outputs are ranges + rationale and escalation flags.</div>
        </div>
        <div class="badgeRow" id="statusBadges">
          <span class="pill"><span class="dot"></span><span id="badgeText">Ready</span></span>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" id="tabA">Step A · Baseline</div>
        <div class="tab" id="tabB">Step B · Repeat / Trial</div>
        <div class="tab" id="tabS">Summary</div>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- STEP A -->
    <div id="panelA">
      <div class="grid">
        <div class="card">
          <h2>Baseline input (ABG A + oxygen device at time of sample)</h2>

          <div class="row">
            <div>
              <label>Context</label>
              <select id="context">
                <option value="unknown" selected>Unknown / mixed</option>
                <option value="copd">AECOPD / CO₂ retention risk</option>
                <option value="cpo">Cardiogenic pulmonary oedema</option>
                <option value="ohs">Obesity hypoventilation / NMD / chest-wall</option>
                <option value="hypox">De novo hypoxemic failure (pneumonia/ARDS) — caution</option>
                <option value="lactic">Predominantly lactic metabolic acidosis</option>
                <option value="asthma">Acute severe asthma (NIV selective)</option>
              </select>
            </div>
            <div>
              <label>SpO₂ target</label>
              <select id="spo2Target">
                <option value="normal" selected>92–96% (most adults)</option>
                <option value="copd">88–92% (COPD/chronic CO₂ risk)</option>
                <option value="custom">Custom (type below)</option>
              </select>
              <input id="spo2Custom" class="hidden" placeholder="e.g., 90–94" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>ABG units</label>
              <select id="units">
                <option value="mmhg" selected>mmHg</option>
                <option value="kpa">kPa</option>
              </select>
            </div>
            <div>
              <label>Device used for ABG A</label>
              <select id="devA">
                <option value="ra">Room air</option>
                <option value="nc" selected>Nasal cannula</option>
                <option value="simple">Simple mask</option>
                <option value="nrb">Non-rebreather</option>
                <option value="venturi">Venturi (enter %)</option>
                <option value="hfnc">HFNC (enter %)</option>
                <option value="niv">NIV/CPAP (enter %)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Flow (L/min) OR set FiO₂ (%)</label>
              <input id="flowOrFio2A" type="number" step="0.1" placeholder="e.g., 2 (L/min) or 40 (FiO₂%)" />
              <div class="small">If you know actual FiO₂, enter percent (≥22) for best accuracy.</div>
            </div>
            <div>
              <label>Optional device notes</label>
              <input id="devNotesA" placeholder="e.g., mouth breathing, poor seal, etc."/>
            </div>
          </div>

          <div class="row3">
            <div><label>pH</label><input id="phA" type="number" step="0.01" placeholder="7.28"/></div>
            <div><label>PaCO₂</label><input id="pco2A" type="number" step="0.1" placeholder="mmHg or kPa"/></div>
            <div><label>PaO₂</label><input id="po2A" type="number" step="0.1" placeholder="mmHg or kPa"/></div>
          </div>

          <div class="row3">
            <div><label>HCO₃⁻ (mmol/L)</label><input id="hco3A" type="number" step="0.1" placeholder="24"/></div>
            <div><label>RR (optional)</label><input id="rrA" type="number" step="1" placeholder="e.g., 30"/></div>
            <div><label>SpO₂ (optional)</label><input id="spo2A" type="number" step="1" placeholder="e.g., 88"/></div>
          </div>

          <details>
            <summary>Optional labs for more rules (anion gap / delta ratio / lactate) + HACOR</summary>
            <div class="row3">
              <div><label>Na⁺</label><input id="naA" type="number" step="0.1" placeholder="140"/></div>
              <div><label>Cl⁻</label><input id="clA" type="number" step="0.1" placeholder="102"/></div>
              <div><label>Albumin (g/dL)</label><input id="albA" type="number" step="0.1" placeholder="4.0"/></div>
            </div>
            <div class="row3">
              <div><label>Lactate</label><input id="lacA" type="number" step="0.1" placeholder="e.g., 5.1"/></div>
              <div><label>HR (HACOR)</label><input id="hrA" type="number" step="1" placeholder="e.g., 118"/></div>
              <div><label>GCS (HACOR)</label><input id="gcsA" type="number" step="1" placeholder="15"/></div>
            </div>
            <div class="small">HACOR uses HR, pH, GCS, RR, and PaO₂/FiO₂. If FiO₂ is estimated, HACOR is shown as a range.</div>
          </details>

          <div class="btnRow">
            <button id="btnAnalyzeA">Analyze A</button>
            <button class="secondary" id="btnExampleA">Fill example</button>
            <button class="secondary" id="btnClearA">Clear A</button>
          </div>

          <div class="divider"></div>

          <div class="panel" id="fio2PanelA">
            <div class="pill"><span class="dot"></span>Estimated FiO₂ (A)</div>
            <div class="mono" id="fio2OutA">—</div>
            <div class="small" id="fio2WhyA"></div>
          </div>

        </div>

        <div class="card rightSticky">
          <h2>Baseline outputs</h2>

          <div class="panel" id="panelInterpretA">
            <div class="pill"><span class="dot"></span>Interpretation (A)</div>
            <div class="mono" id="interpretA">Enter values → Analyze A.</div>
          </div>

          <div class="divider"></div>

          <div class="panel" id="panelPlanA">
            <div class="pill"><span class="dot"></span>Suggested therapy + NIV ranges (A)</div>
            <div class="mono" id="planA">—</div>
          </div>

          <div class="divider"></div>

          <div class="panel bad" id="panelFailA">
            <div class="pill"><span class="dot bad"></span>Escalation / “don’t persist” flags (A)</div>
            <div class="mono" id="flagsA">—</div>
          </div>

          <div class="chips" id="chipsA"></div>

        </div>
      </div>
    </div>

    <!-- STEP B -->
    <div id="panelB" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Repeat (ABG B) + time on therapy + settings used</h2>
          <div class="muted">Run “Analyze A” first; Step B compares response and checks for failing NIV trial.</div>

          <div class="row">
            <div>
              <label>Minutes on current therapy before ABG B</label>
              <input id="minsB" type="number" step="1" placeholder="e.g., 60"/>
            </div>
            <div>
              <label>Therapy in place during ABG B</label>
              <select id="therapyB">
                <option value="o2" selected>O₂ only</option>
                <option value="hfnc">HFNC</option>
                <option value="cpap">CPAP</option>
                <option value="niv">BiPAP/NIV</option>
                <option value="imv">Intubated/IMV</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>FiO₂ set (%) (preferred)</label>
              <input id="fio2SetB" type="number" step="0.1" placeholder="e.g., 35"/>
              <div class="small">If you don’t enter this, the app may fall back to an estimate (less reliable).</div>
            </div>
            <div>
              <label>NIV settings (optional but helpful)</label>
              <input id="nivSettingsB" placeholder="e.g., BiPAP 14/5, backup 14; or CPAP 8"/>
            </div>
          </div>

          <div class="row3">
            <div><label>pH (B)</label><input id="phB" type="number" step="0.01" placeholder="7.32"/></div>
            <div><label>PaCO₂ (B)</label><input id="pco2B" type="number" step="0.1" placeholder="mmHg or kPa"/></div>
            <div><label>PaO₂ (B)</label><input id="po2B" type="number" step="0.1" placeholder="mmHg or kPa"/></div>
          </div>

          <div class="row3">
            <div><label>HCO₃⁻ (B)</label><input id="hco3B" type="number" step="0.1" placeholder="24"/></div>
            <div><label>RR (B) (optional)</label><input id="rrB" type="number" step="1" placeholder="e.g., 24"/></div>
            <div><label>SpO₂ (B) (optional)</label><input id="spo2B" type="number" step="1" placeholder="e.g., 90"/></div>
          </div>

          <details>
            <summary>Optional: lactate + HACOR components (B)</summary>
            <div class="row3">
              <div><label>Lactate (B)</label><input id="lacB" type="number" step="0.1" placeholder="e.g., 3.0"/></div>
              <div><label>HR (B)</label><input id="hrB" type="number" step="1" placeholder="e.g., 110"/></div>
              <div><label>GCS (B)</label><input id="gcsB" type="number" step="1" placeholder="15"/></div>
            </div>
          </details>

          <div class="row">
            <div>
              <label>Notes / observed response (optional)</label>
              <textarea id="notesB" placeholder="e.g., reduced WOB; still drowsy; leaks; hypotensive; etc."></textarea>
            </div>
            <div class="panel">
              <div class="pill"><span class="dot"></span>Estimated FiO₂ (B)</div>
              <div class="mono" id="fio2OutB">—</div>
              <div class="small" id="fio2WhyB"></div>
            </div>
          </div>

          <div class="btnRow">
            <button id="btnAnalyzeB">Analyze B</button>
            <button class="secondary" id="btnExampleB">Fill example</button>
            <button class="secondary" id="btnClearB">Clear B</button>
          </div>
        </div>

        <div class="card rightSticky">
          <h2>Trial response outputs</h2>

          <div class="panel" id="panelTrend">
            <div class="pill"><span class="dot"></span>Trend A → B</div>
            <div class="mono" id="trendOut">Run Analyze A then Analyze B.</div>
          </div>

          <div class="divider"></div>

          <div class="panel" id="panelVQ">
            <div class="pill"><span class="dot"></span>V/Q vs shunt-like suggestion (heuristic)</div>
            <div class="mono" id="vqOut">—</div>
          </div>

          <div class="divider"></div>

          <div class="panel bad" id="panelFailB">
            <div class="pill"><span class="dot bad"></span>Failing NIV trial check (evidence-based heuristic)</div>
            <div class="mono" id="failOut">—</div>
          </div>

          <div class="divider"></div>

          <div class="panel" id="panelAdjust">
            <div class="pill"><span class="dot"></span>Suggested adjustments + rationale</div>
            <div class="mono" id="adjustOut">—</div>
          </div>

        </div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="panelS" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Auto-generated clinical summary</h2>
          <div class="muted">Designed to be copy-pastable into handover notes: assessment → intervention → rationale → response → next step.</div>
          <div class="divider"></div>
          <div class="panel">
            <div class="mono" id="summaryOut">Run Analyze A (and optionally Analyze B) to populate this.</div>
          </div>
          <div class="btnRow">
            <button class="secondary" id="btnCopySummary">Copy summary</button>
            <button class="secondary" id="btnCopyAll">Copy all outputs</button>
          </div>
        </div>
        <div class="card rightSticky">
          <h2>How “failing NIV trial” is judged here</h2>
          <div class="muted">
            This app uses a conservative combination of:
            <ul>
              <li><b>HACOR score</b> (range if FiO₂ is estimated). A cutoff <b>&gt;5</b> suggests high NIV failure risk.</li>
              <li><b>Early physiologic response</b>: within ~1–4h, lack of improvement in pH/RR or worsening CO₂ is concerning.</li>
              <li>Simple escalation triggers: reduced consciousness, persistent tachypnea, inability to maintain target SpO₂, severe acidemia.</li>
            </ul>
            This is a decision-support heuristic—not a substitute for ICU/senior review.
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===================== Utilities ===================== */
const mmHgPerKPa = 7.50062;
const isNum = (v) => Number.isFinite(v);
const clamp = (x, lo, hi) => Math.min(hi, Math.max(lo, x));
const $ = (id) => document.getElementById(id);
const valNum = (id) => {
  const v = $(id).value;
  if (v === "" || v === null || v === undefined) return NaN;
  const n = Number(v);
  return Number.isFinite(n) ? n : NaN;
};
const fmt = (n, d=2) => isNum(n) ? n.toFixed(d) : "—";
const toMMHg = (v, units) => units === "kpa" ? v * mmHgPerKPa : v;
const fromMMHg = (v, units) => units === "kpa" ? v / mmHgPerKPa : v;

function setBadge(kind, text){
  const row = $("statusBadges");
  row.innerHTML = "";
  const dotClass = kind === "good" ? "good" : kind === "warn" ? "warn" : kind === "bad" ? "bad" : "";
  row.innerHTML = `<span class="pill"><span class="dot ${dotClass}"></span><span>${text}</span></span>`;
}

function addChip(text, tone){
  const div = document.createElement("div");
  div.className = `chip ${tone||""}`;
  div.textContent = text;
  $("chipsA").appendChild(div);
}

/* ===================== FiO2 estimation ===================== */
function fio2FromDevice(device, flowOrPct){
  // If value >=22, assume FiO2 percent. Otherwise treat as flow L/min for variable devices.
  if (device === "ra") return {min:0.21, max:0.21, why:"Room air (~21%).", conf:"baseline"};
  if (!isNum(flowOrPct)) return {min:NaN, max:NaN, why:"Enter flow (L/min) or FiO₂ (%).", conf:"unknown"};

  if (flowOrPct >= 22){
    const f = clamp(flowOrPct/100, 0.21, 1.0);
    return {min:f, max:f, why:"Using user-entered set FiO₂.", conf:"high (user-set)"};
  }

  const L = flowOrPct;
  if (device === "nc"){
    // rough NC range: 0.21 + (0.03–0.04)*L, cap ~0.44
    const min = clamp(0.21 + 0.03*L, 0.21, 0.44);
    const max = clamp(0.21 + 0.04*L, 0.21, 0.44);
    return {min, max, why:"NC heuristic: variable with minute ventilation.", conf:"variable"};
  }
  if (device === "simple"){
    // broad range, very variable
    const min = clamp(0.28 + 0.01*(L-6), 0.25, 0.45);
    const max = clamp(0.40 + 0.02*(L-6), 0.35, 0.60);
    return {min, max, why:"Simple mask heuristic: highly variable.", conf:"low"};
  }
  if (device === "nrb"){
    const min = clamp(0.60 + 0.01*(L-10), 0.55, 0.75);
    const max = clamp(0.80 + 0.02*(L-10), 0.75, 0.95);
    return {min, max, why:"NRB heuristic: seal/bag/valves matter.", conf:"variable-high"};
  }
  // Venturi/HFNC/NIV should be set FiO2%
  if (device === "venturi" || device === "hfnc" || device === "niv"){
    return {min:NaN, max:NaN, why:"For Venturi/HFNC/NIV: enter FiO₂% (e.g., 28, 35, 40).", conf:"unknown"};
  }
  return {min:NaN, max:NaN, why:"Unknown device mapping.", conf:"unknown"};
}

/* ===================== Indices ===================== */
function calcPAO2(fio2, paco2mm){
  // PAO2 = FiO2*(Patm-PH2O) - PaCO2/RQ
  const Patm = 760, PH2O = 47, RQ = 0.8;
  if (!isNum(fio2) || !isNum(paco2mm)) return NaN;
  return fio2*(Patm-PH2O) - paco2mm/RQ;
}
function indices({pao2mm, paco2mm, fio2min, fio2max, spo2, units}){
  const out = {};
  if (isNum(pao2mm) && isNum(fio2min) && isNum(fio2max)){
    out.pfLow = pao2mm / fio2max;  // lower PF (worse) at higher FiO2
    out.pfHigh = pao2mm / fio2min;
  } else {
    out.pfLow = NaN; out.pfHigh = NaN;
  }
  if (isNum(spo2) && isNum(fio2min) && isNum(fio2max)){
    out.sfLow = spo2 / fio2max;
    out.sfHigh = spo2 / fio2min;
  } else {
    out.sfLow = NaN; out.sfHigh = NaN;
  }
  // A-a / a/A using mid FiO2 for readability, also a range if FiO2 is ranged
  if (isNum(pao2mm) && isNum(paco2mm) && isNum(fio2min) && isNum(fio2max)){
    const fMid = (fio2min + fio2max)/2;
    const PA = calcPAO2(fMid, paco2mm);
    out.PAO2 = PA;
    out.Aa = PA - pao2mm;
    out.aA = pao2mm / PA;
    // range for Aa with fio2 min/max
    const PAmin = calcPAO2(fio2min, paco2mm);
    const PAmax = calcPAO2(fio2max, paco2mm);
    out.AaMin = Math.min(PAmin - pao2mm, PAmax - pao2mm);
    out.AaMax = Math.max(PAmin - pao2mm, PAmax - pao2mm);
    out.aAMin = Math.min(pao2mm/PAmin, pao2mm/PAmax);
    out.aAMax = Math.max(pao2mm/PAmin, pao2mm/PAmax);
  } else {
    out.PAO2 = NaN; out.Aa = NaN; out.aA = NaN;
    out.AaMin = NaN; out.AaMax = NaN;
    out.aAMin = NaN; out.aAMax = NaN;
  }
  return out;
}
function oxygenLabel(pf){
  if (!isNum(pf)) return "unknown";
  if (pf < 100) return "very severe";
  if (pf < 150) return "severe";
  if (pf < 200) return "moderate";
  if (pf < 300) return "mild";
  return "near-normal";
}

/* ===================== Acid-base rules ===================== */
function expPCO2_Winter(hco3){ return 1.5*hco3 + 8; } // ±2
function expPCO2_MetAlk(hco3){ return 0.7*(hco3-24) + 40; } // ±5
function expHCO3_RespAcid(pco2mm, chronic){ return 24 + (chronic?4:1) * ((pco2mm - 40)/10); }
function expHCO3_RespAlk(pco2mm, chronic){ return 24 - (chronic?5:2) * ((40 - pco2mm)/10); }

function acidBase(ph, pco2mm, hco3){
  if (![ph,pco2mm,hco3].every(isNum)) return {primary:"Undetermined", text:"Need pH + PaCO₂ + HCO₃⁻.", flags:[]};
  const flags = [];
  const acidemia = ph < 7.35;
  const alkalemia = ph > 7.45;
  const pco2High = pco2mm > 45;
  const pco2Low = pco2mm < 35;
  const hLow = hco3 < 22;
  const hHigh = hco3 > 26;

  let primary = "Near-normal pH / mixed disorder possible";
  if (acidemia){
    if (pco2High && !hLow) primary = "Primary respiratory acidosis likely";
    else if (hLow && !pco2High) primary = "Primary metabolic acidosis likely";
    else if (hLow && pco2High) primary = "Mixed metabolic + respiratory acidosis possible";
    else primary = "Acidemia with unclear driver";
  } else if (alkalemia){
    if (pco2Low && !hHigh) primary = "Primary respiratory alkalosis likely";
    else if (hHigh && !pco2Low) primary = "Primary metabolic alkalosis likely";
    else if (hHigh && pco2Low) primary = "Mixed metabolic + respiratory alkalosis possible";
    else primary = "Alkalemia with unclear driver";
  }

  const lines = [];
  lines.push(`Acid–base: ${primary}`);
  // metabolic acidosis compensation
  if (hLow){
    const exp = expPCO2_Winter(hco3);
    lines.push(`• Winter: expected PaCO₂ ≈ ${fmt(exp,1)} ±2 mmHg`);
    if (pco2mm > exp + 2) lines.push("  ↳ PaCO₂ higher than expected → concurrent resp acidosis/vent failure");
    if (pco2mm < exp - 2) lines.push("  ↳ PaCO₂ lower than expected → concurrent resp alkalosis");
  }
  if (hHigh){
    const exp = expPCO2_MetAlk(hco3);
    lines.push(`• Met alkalosis: expected PaCO₂ ≈ ${fmt(exp,1)} ±5 mmHg`);
    if (pco2mm > exp + 5) lines.push("  ↳ PaCO₂ higher than expected → concurrent resp acidosis");
    if (pco2mm < exp - 5) lines.push("  ↳ PaCO₂ lower than expected → concurrent resp alkalosis");
  }
  // respiratory compensation
  if (pco2High){
    const expA = expHCO3_RespAcid(pco2mm,false);
    const expC = expHCO3_RespAcid(pco2mm,true);
    lines.push(`• Resp acidosis expected HCO₃⁻: acute≈${fmt(expA,1)}, chronic≈${fmt(expC,1)}`);
    if (hco3 < expA - 2) lines.push("  ↳ HCO₃⁻ lower than expected → extra metabolic acidosis");
    if (hco3 > expC + 3) lines.push("  ↳ HCO₃⁻ higher than expected → extra metabolic alkalosis / very chronic");
  }
  if (pco2Low){
    const expA = expHCO3_RespAlk(pco2mm,false);
    const expC = expHCO3_RespAlk(pco2mm,true);
    lines.push(`• Resp alkalosis expected HCO₃⁻: acute≈${fmt(expA,1)}, chronic≈${fmt(expC,1)}`);
    if (hco3 > expA + 2) lines.push("  ↳ HCO₃⁻ higher than expected → extra metabolic alkalosis");
    if (hco3 < expC - 3) lines.push("  ↳ HCO₃⁻ lower than expected → extra metabolic acidosis");
  }

  if (ph < 7.25) flags.push("High-risk acidemia (pH < 7.25)");
  if (ph < 7.20) flags.push("Severe acidemia (pH < 7.20)");
  if (pco2mm > 60) flags.push("Marked hypercapnia");
  if (pco2mm > 80) flags.push("Severe hypercapnia");
  return {primary, text: lines.join("\n"), flags};
}

/* ===================== Anion gap / delta ratio ===================== */
function anionGap(na, cl, hco3, alb){
  if (![na,cl,hco3].every(isNum)) return {ag:NaN, agCorr:NaN, ratio:NaN};
  const ag = na - (cl + hco3);
  const agCorr = isNum(alb) ? (ag + 2.5*(4.0 - alb)) : ag;
  const deltaAG = agCorr - 12;
  const deltaH = 24 - hco3;
  const ratio = (deltaH !== 0) ? (deltaAG / deltaH) : NaN;
  return {ag, agCorr, ratio};
}

/* ===================== HACOR score (range if FiO2 range) ===================== */
function hacorPtsHR(hr){ return (hr >= 121) ? 1 : 0; }
function hacorPtsPH(ph){
  if (ph >= 7.35) return 0;
  if (ph >= 7.30) return 2;
  if (ph >= 7.25) return 3;
  return 4;
}
function hacorPtsGCS(gcs){
  if (gcs === 15) return 0;
  if (gcs >= 13) return 2;
  if (gcs >= 11) return 5;
  return 10;
}
function hacorPtsRR(rr){
  if (rr <= 30) return 0;
  if (rr <= 35) return 1;
  if (rr <= 40) return 2;
  if (rr <= 45) return 3;
  return 4;
}
function hacorPtsPF(pf){
  if (pf >= 201) return 0;
  if (pf >= 176) return 2;
  if (pf >= 151) return 3;
  if (pf >= 126) return 4;
  if (pf >= 101) return 5;
  return 6;
}
function hacorRange({hr, ph, gcs, rr, pao2mm, fio2min, fio2max}){
  if (![hr,ph,gcs,rr,pao2mm].every(isNum) || ![fio2min,fio2max].every(isNum)){
    return {min:NaN, max:NaN, note:"Need HR, pH, GCS, RR, PaO₂ and FiO₂."};
  }
  const base = hacorPtsHR(hr) + hacorPtsPH(ph) + hacorPtsGCS(gcs) + hacorPtsRR(rr);
  // PF varies with FiO2 range
  const pfLow = pao2mm / fio2max;
  const pfHigh = pao2mm / fio2min;
  const ptsLow = hacorPtsPF(pfLow);
  const ptsHigh = hacorPtsPF(pfHigh);
  const min = base + Math.min(ptsLow, ptsHigh);
  const max = base + Math.max(ptsLow, ptsHigh);
  return {min, max, note:"HACOR shown as range if FiO₂ is estimated."};
}

/* ===================== Plan suggestion + trial logic ===================== */
function targetText(){
  const t = $("spo2Target").value;
  if (t === "custom") return ($("spo2Custom").value || "custom target");
  if (t === "copd") return "88–92%";
  return "92–96%";
}

/* (JS continues exactly as in the downloadable file) */
</script>
</body>
</html>